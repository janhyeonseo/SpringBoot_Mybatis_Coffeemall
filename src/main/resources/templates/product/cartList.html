<html xmlns:th="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>

<body>
	<link href="/css/style_cartList.css" rel="stylesheet" type="text/css" />
	<div th:replace="~{include/top}"></div>

	<script type="text/javascript" th:inline="javascript">
		function delOne(cid, pname) {
			alert("ë©”ë‰´ '" + pname + "'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
			location.href = "/product/cartDel?cid=" + cid
		}

		function delK() {
			cid = f1.cid.value
			f1.action = "/product/cartDel2"
		}
	</script>
	<section class="cart-container">

		<form name="f1">
			<fieldset>
				<legend> ë‚´ ì¥ë°”êµ¬ë‹ˆ</legend>

				<table class="cart-table">
					<thead>
						<tr>
							<th>ìˆœë²ˆ</th>
							<th>ìƒí’ˆì´ë¯¸ì§€</th>
							<th>ìƒí’ˆì´ë¦„</th>
							<th>ìƒí’ˆê°€ê²©</th>
							<th>ìˆ˜ëŸ‰</th>
							<th>ì·¨ì†Œ</th>
						</tr>
					</thead>
					<tbody>
						<th:block th:if="${li.size() < 1}">
							<tr>
								<td colspan="6" class="empty-cart">ğŸ›’ ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!</td>
							</tr>
						</th:block>

						<th:block th:if="${li.size() >= 1}">
							<tr th:each="m, mStat: ${li}">
								<td th:text="${mStat.index + 1}"></td>
								<td>
									<input type="hidden" name="cid" th:value="${m.cid}">
									<input type="hidden" name="pname" th:value="${m.pname}">
									<a th:href="@{/product/productEdit(pid=${m.pid})}">
										<img th:if="${m.pimgStr != null and #strings.startsWith(m.pimgStr, 'http')}"
											th:src="${m.pimgStr}" class="product-img" />
										<img th:if="${m.pimgStr != null and !#strings.startsWith(m.pimgStr, 'http')}"
											th:src="@{/product/files/}+${m.pimgStr}" class="product-img" />
									</a>
								</td>
								<td th:text="${m.pname}"></td>
								<td th:text="${m.pprice}"></td>
								<td th:text="${m.amount}"></td>
								<td>
									<button type="button" class="delete-btn"
										th:onClick="delOne([[${m.cid}]], [[${m.pname}]])">ğŸ—‘</button>
								</td>
							</tr>
						</th:block>
					</tbody>
				</table>
			</fieldset>

			<th:block th:if="${li.size() >= 1}">
				<div class="cart-actions">
					<button type="button" class="btn-large pay-btn" th:onclick="kg_request_pay()">ğŸ’³ ê²°ì œí•˜ê¸°</button>
					<input type="submit" class="btn-large delete-all-btn" value="ğŸ—‘ ì „ì²´ì‚­ì œ" onClick="delK()">
				</div>

				<div class="total-price">
					ğŸ’° ê²°ì œê¸ˆì•¡: <span th:text="${total}"></span> ì›
				</div>
			</th:block>
		</form>
	</section>

	<script th:inline="javascript">
		jQuery.ajaxSetup({
			cache: false
		});

		function kg_request_pay() {
			//ì „ë‹¬í•  ë°ì´í„° 4ê°€ì§€ëŠ” í•„ìˆ˜ ê°’
			// data-name(ìƒí’ˆì´ë¦„), data-price(ê°€ê²©) , data-goodsnum(ì£¼ë¬¸ë²ˆí˜¸) " 
			var selectedDate = document.getElementById("datepicker").value;
			var selectedGoodsName = document.querySelector(".kg_pay_btn")
				.getAttribute("data-name");
			var selectedGoodsPrice = document.querySelector(".kg_pay_btn")
				.getAttribute("data-price");
			var selectedGoodsNum = document.querySelector(".kg_pay_btn")
				.getAttribute("data-goodsnum");

			if (!selectedGoodsName || !selectedGoodsPrice || !selectedGoodsNum) {
				alert("ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
				return;
			}
			//kgì´ë‹ˆì‹œìŠ¤ ê²°ì œ API
			var IMP = window.IMP; // ìƒëµê°€ëŠ¥
			IMP.init('imp33165546'); // ê°€ë§¹ì  ì‹ë³„ì½”ë“œ

			// IMP.request_pay(param, callback) ê²°ì œì°½ í˜¸ì¶œ
			IMP.request_pay({
				pg: "html5_inicis",
				pay_method: "card",
				merchant_uid: "gpay_" + new Date().getTime(), // ì£¼ë¬¸ë²ˆí˜¸
				name: selectedGoodsName, // ìƒí’ˆì´ë¦„
				amount: selectedGoodsPrice, // ìƒí’ˆê°€ê²© (ìˆ«ì íƒ€ì…)
			}, function (rsp) { // callback
				console.log(rsp);
				if (rsp.success) { //ê²°ì œ ì„±ê³µì‹œ
					var msg = 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
					var result = {
						"mpaynum": rsp.merchant_uid, //ê²°ì œë²ˆí˜¸
						"membernum": "AA00001", //íšŒì›ë²ˆí˜¸
						"mpaymethod": rsp.pay_method, //ê²°ì œìˆ˜ë‹¨
						"mpayproduct": rsp.name, //ê°€ê²Œ ì´ë¦„ + ìƒí’ˆì´ë¦„
						"mpayprice": rsp.paid_amount, // ê²°ì œê¸ˆì•¡
						"mpaydate": new Date().toISOString().slice(0, 10), //ê²°ì œì¼
						"mpaygym": "makeCoffee", //ê°€ê²Œ ì´ë¦„
						"mpayperiod": selectedDate, //ìƒí’ˆì´ìš©ê¸°ê°„
						"mpaytime": "",
						"trainername": "",
						"ggoodsnum": selectedGoodsNum, //ìƒí’ˆë²ˆí˜¸
						"tgoodsint": null,
						"gymnum": "B0001" //ê°€ê²Œ ê³ ìœ ë²ˆí˜¸
					}
					console.log(result);

					$.ajax({
						url: '/PortOneT/insertMPay',
						type: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(result),
						success: function (res) {
							console.log(res);
							location.href = res;
						},
						error: function (err) {
							console.log(err);
						}
					}); //ajax
				} else {
					var msg = 'ê²°ì œ ì‹¤íŒ¨';
					msg += '\nì—ëŸ¬ë‚´ìš© : ' + rsp.error_msg;
				}
				alert(msg);
			});
		}
	</script>


	<div th:replace="~{include/bottom::footer}"></div>
</body>

</html>